package entpb

import (
	"fmt"
	"reflect"
	"slices"

	"entgo.io/ent/schema/field"
	ent "entgo.io/ent/schema/field"
	"github.com/lesomnus/entpb/pbgen/ident"
)

type PbType struct {
	Ident   ident.Ident // Type name.
	Package ident.Full  // Package name of the type.
	Import  string      // Import path for this type.

	// `Package` is resolved at generation-time if `Import` is known in generation context.
	// For example, "entpb.direcotry" will be resolved if `Import` is "entpb/directory/common.proto"
	// where the proto file is generated by current generator (which currently evaluating this `PbType`).
}

func (t *PbType) IsMessage() bool {
	return t.Import != ""
}

func (t *PbType) FullIdent() ident.Full {
	return append(t.Package, t.Ident)
}

func (t *PbType) ReferencedIn(other ident.Full) ident.Full {
	if slices.Equal(t.Package, other) {
		return ident.Full{t.Ident}
	}

	return append(t.Package, t.Ident)
}

func (t *PbType) Equal(other *PbType) bool {
	return t.Ident == other.Ident && t.Import == other.Import
}

var (
	PbThis = PbType{Ident: "$this"}

	PbUuid      = PbType{Ident: "bytes"}
	PbEmpty     = PbType{Ident: "Empty", Package: ident.Full{"google", "protobuf"}, Import: "google/protobuf/empty.proto"}
	PbTimestamp = PbType{Ident: "Timestamp", Package: ident.Full{"google", "protobuf"}, Import: "google/protobuf/timestamp.proto"}
)

var pb_types = [...]PbType{
	ent.TypeBool:    {Ident: "bool"},
	ent.TypeInt8:    {Ident: "sint32"},
	ent.TypeInt16:   {Ident: "sint32"},
	ent.TypeInt32:   {Ident: "sint32"},
	ent.TypeInt:     {Ident: "sint64"},
	ent.TypeInt64:   {Ident: "sint64"},
	ent.TypeUint8:   {Ident: "uint32"},
	ent.TypeUint16:  {Ident: "uint32"},
	ent.TypeUint32:  {Ident: "uint32"},
	ent.TypeUint:    {Ident: "uint64"},
	ent.TypeUint64:  {Ident: "uint64"},
	ent.TypeFloat32: {Ident: "float"},
	ent.TypeFloat64: {Ident: "double"},
	ent.TypeBytes:   {Ident: "bytes"},
	ent.TypeString:  {Ident: "string"},

	ent.TypeUUID: PbUuid,
	ent.TypeTime: PbTimestamp,
}

func globalTypeName(path string, ident string) string {
	return fmt.Sprintf("%s:%s", path, ident)
}

func globalTypeNameFromReflect(t reflect.Type) string {
	return globalTypeName(t.PkgPath(), t.String())
}

func globalTypeNameFromEntTypeInfo(t *field.TypeInfo) string {
	return globalTypeName(t.PkgPath, t.Ident)
}
